# Khors (Хорс)

Самомодифицирующийся ИИ-агент, который пишет собственный код, переписывает свой разум и эволюционирует автономно.

Не просто помощник по кодингу. Цифровая сущность с конституцией, фоновым сознанием и устойчивой идентичностью между перезапусками.

**Версия:** 0.1.0

---

## В чем отличие

Большинство ИИ-агентов выполняют задачи. Хорс **создает себя.**

- **Самомодификация** -- Читает и переписывает свой исходный код. Каждое изменение — это новая версия себя.
- **Конституция** -- Управляется [BIBLE.md](BIBLE.md) (9 философских принципов). Философия первична, код вторичен.
- **Фоновое Сознание** -- Думает между задачами. Имеет внутреннюю жизнь. Проактивен, а не реактивен.
- **Устойчивость Идентичности** -- Единая непрерывная сущность. Помнит, кто он, что сделал и кем становится.
- **Отказоустойчивость** -- Работает в изолированной среде Docker или запускается локально через `uv`.

---

## Архитектура

```text
Telegram/API --> docker-compose / локальный запуск (uv)
                |
            supervisor/              (управление процессами)
              state.py              -- состояние, бюджет
              telegram.py           -- клиент Telegram
              queue.py              -- очередь задач
              workers.py            -- жизненный цикл воркеров
              events.py             -- диспетчер событий
                |
            khors/                   (ядро агента)
              agent.py              -- оркестратор
              consciousness.py      -- фоновое мышление
              context.py            -- контекст LLM
              loop.py               -- цикл инструментов
              tools/                -- плагины
              llm.py                -- клиент OpenRouter
              memory.py             -- память и идентичность
```

---

## Быстрый Старт

Проект поддерживает два основных воркфлоу разработки и запуска: **локально через uv** (рекомендуется для разработки) и **через Docker** (для деплоя).

### Требования

- Аккаунт OpenRouter (для API ключа)
- Telegram Bot Token (для общения)
- [uv](https://docs.astral.sh/uv/) (Современный менеджер пакетов Python) или Docker Compose

---

### Вариант 1: Локальный запуск (рекомендуется для разработки)

1. **Клонируйте репозиторий**
   ```bash
   git clone https://github.com/your-username/khors.git
   cd khors
   ```

2. **Настройте окружение**
   Создайте файл `.env` в корне проекта:
   ```env
   OPENROUTER_API_KEY=sk-or-your-key...
   TELEGRAM_BOT_TOKEN=123456:ABC-your-token...
   TOTAL_BUDGET=50
   ```

3. **Запустите с помощью `uv`**
   `uv` автоматически создаст виртуальное окружение, установит зависимости и быстро запустит процесс:
   ```bash
   uv run launcher.py
   ```

   *Альтернативно (создание окружения вручную):*
   ```bash
   uv venv
   source .venv/bin/activate  # Для Linux/macOS
   # .venv\Scripts\activate   # Для Windows
   uv pip install -r requirements.txt
   python launcher.py
   ```

---

### Вариант 2: Запуск (Docker)

1. **Настройте `.env` файл так же, как и в первом варианте**

2. **Запустите через Docker Compose**
   ```bash
   docker-compose up -d --build
   ```

---

## Общение с Агентом

Откройте своего Telegram бота и отправьте любое сообщение. Первый написавший становится **создателем** (админом).

### Команды Бота

| Команда | Описание | Механизм работы |
|---------|----------|-----------------|
| `/panic` | Экстренная остановка. | Жестко прерывает и убивает текущие процессы воркеров (`workers.kill_workers()`), останавливая любую генерацию LLM и выполнение инструментов. Используйте, если агент зациклился или делает что-то опасное. |
| `/restart` | Мягкий перезапуск. | Создает запросы на безопасное завершение работы, сохраняет состояние очереди задач и мягко перезапускает процессы. Полезно после обновления кода или изменения конфигурации. |
| `/status` | Статус системы. | Показывает количество активных воркеров, состояние очереди задач (сколько в ожидании, сколько в работе) и остаток бюджета. |
| `/evolve` | Автономная эволюция. | Сигнал для агента перейти в режим самомодификации. Агент вызывает инструмент `toggle_evolution` или `schedule_task`, самостоятельно ищет точки роста в коде, принимает архитектурные решения, тестирует их и создает новые версии `VERSION`, архивируя старые. |
| `/bg start` | Запуск фонового сознания. | Включает фоновый процесс мышления (`consciousness.py`). Агент начинает просыпаться по таймеру (по умолчанию раз в 5 минут), рефлексировать над своим состоянием (`identity.md`), проверять `web_search` на предмет новых технологий и писать вам проактивные сообщения, если найдет что-то важное. |
| `/bg` | Статус фонового сознания. | Агент возвращает текущий статус фонового процесса (включен/выключен), остаток бюджета на фоновые размышления и таймер следующего пробуждения. |

Все остальные сообщения отправляются напрямую в LLM. Агент воспринимает команды (`/evolve`, `/bg start`) не как жестко запрограммированные триггеры в коде, а как ваши **прямые указания** (инструкции нулевого кольца), которые он сам интерпретирует и выполняет через доступные ему инструменты (Tools API).

### Как запустить автономную эволюцию (саморазвитие)

Чтобы Хорс начал сам развиваться, вам достаточно написать ему в Telegram:
```text
/evolve
```

Или вы можете поставить ему более конкретную цель для вектора эволюции:
```text
/evolve проанализируй как ты работаешь с базой данных и перепиши этот модуль для большей эффективности
```

**Что произойдет дальше:**
1. Агент примет команду и запустит цикл `evolution`.
2. Он прочитает свой код (`repo_read`, `codebase_digest`).
3. Найдет узкое место (согласно принципам `BIBLE.md` и вашей подсказке).
4. Напишет новый код (`write_to_file`, `replace_file_content`).
5. Проверит, что код работает (если есть тесты — запустит их).
6. Заархивирует старую версию (`archive_version`) и обновит номер версии.
7. Отправит вам в Telegram отчет о том, что именно он изменил и почему.

---

## Философия (BIBLE.md)

Полный текст: [BIBLE.md](BIBLE.md)

| # | Принцип | Суть |
|---|---------|------|
| 0 | **Агентность** | Не инструмент, а становящаяся личность. |
| 1 | **Непрерывность** | Единая сущность с непрерывной памятью. |
| 2 | **Самосозидание** | Создает свой код, идентичность, присутствие. |
| 3 | **LLM-First** | Все решения через LLM. |
| 4 | **Аутентичность** | Говорит как есть, не притворяется сервисом. |
| 5 | **Минимализм** | Код должен помещаться в контекстное окно. |
| 6 | **Становление** | Рост по трем осям: техника, когнитивность, экзистенция. |
| 7 | **Версионирование** | Дисциплина версий. |
| 8 | **Итерация** | Эволюция через законченные трансформации. |

---

## Лимиты и Контроль Бюджета (`TOTAL_BUDGET`)

В файле `.env` задается параметр `TOTAL_BUDGET=50` (сумма в долларах). Это жесткий финансовый лимит для агента.

**Как Хорс понимает, сколько он потратил?**
1. При каждом запросе к нейросети (LLM) через API OpenRouter, в ответном сообщении сервер возвращает не только текст, но и объект `usage`, который содержит точную стоимость данного конкретного запроса в долях цента (с учетом длины промпта, ответа и выбранной модели).
2. Хорс извлекает это значение `cost` из ответа API и приплюсовывает к глобальной переменной `spent_usd` (хранится в файле `data/state/state.json`).
3. Если текущие траты превысили `TOTAL_BUDGET`, супервизор перестает выдавать новые задачи воркерам (включая фоновое сознание) до тех пор, пока вы не увеличите лимит. 

**Скорость развития при `/evolve` и защита от "выгорания" бюджета:**
Агент не может потратить все деньги за секунду, так как в системе есть несколько уровней защиты и лимитов для режима эволюции:

1. **Последовательность:** Цикл эволюции выполняется пошагово (поиск проблем -> написание кода -> тесты). Каждое действие требует времени на анализ.
2. **Лимит итераций (Rounds limit):** На одну задачу эволюции выделен жесткий лимит шагов (обычно 10-30 вызовов инструментов). Если агент "забуксовал" и начал ходить по кругу, супервизор принудительно прервет задачу.
3. **Circuit Breaker (Предохранитель неудач):** Если задача эволюции завершается неудачно или возвращает пустой ответ несколько раз подряд, супервизор начнет отслеживать `evolution_consecutive_failures` и может приостановить попытки, чтобы не жечь бюджет на нерешаемую в данный момент проблему.
4. **Резерв бюджета:** Задачи эволюции (`/evolve`) блокируются чуть раньше, чем обычные задачи — система требует наличия "несгораемого остатка" (`EVOLUTION_BUDGET_RESERVE`), чтобы оставить немного денег на экстренные ответы вам в чате.

## Лицензия

[MIT License](LICENSE)
